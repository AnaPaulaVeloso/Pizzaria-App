{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração de Produtos</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
</head>
<body>
    <header>
        <h1>Administração de Produtos</h1>
        <div class="nav-buttons">
            <button id="btnPizzas" class="active"><i class="fas fa-pizza-slice"></i> Pizzas</button>
            <button id="btnEsfihas"><i class="fas fa-bread-slice"></i> Esfihas</button>
            <button id="btnBebidas"><i class="fas fa-glass-cheers"></i> Bebidas</button>
            <a href="/" class="admin-button"><i class="fas fa-home"></i> Voltar para Cadastro</a>
        </div>
    </header>

    <main>
        <section id="adminPizzas">
            <h2>Gerenciamento de Pizzas</h2>
            <ul id="listaPizzas" class="admin-list"></ul>
        </section>

        <section id="adminEsfihas" class="hidden">
            <h2>Gerenciamento de Esfihas</h2>
            <ul id="listaEsfihas" class="admin-list"></ul>
        </section>

        <section id="adminBebidas" class="hidden">
            <h2>Gerenciamento de Bebidas</h2>
            <ul id="listaBebidas" class="admin-list"></ul>
        </section>

        <!-- Alerta personalizado -->
        <div id="customAlert" class="custom-alert">
            <div class="alert-content">
                <div class="alert-header">
                    <h5 id="alertTitle"></h5>
                    <span class="close-button" onclick="closeCustomAlert()">&times;</span>
                </div>
                <div class="alert-body">
                    <p id="alertMessage"></p>
                </div>
                <div class="alert-footer">
                    <button onclick="closeCustomAlert()">OK</button>
                </div>
            </div>
        </div>

        <div id="overlay" class="overlay"></div>
    </main>

    <footer>
        <p>&copy; 2023 Sistema de Administração de Produtos - Todos os direitos reservados</p>
    </footer>

    <script>
        // Alternância entre seções
        const secaoPizzas = document.getElementById('adminPizzas');
        const secaoEsfihas = document.getElementById('adminEsfihas');
        const secaoBebidas = document.getElementById('adminBebidas');
        const btnPizzas = document.getElementById('btnPizzas');
        const btnEsfihas = document.getElementById('btnEsfihas');
        const btnBebidas = document.getElementById('btnBebidas');

        document.getElementById('btnPizzas').onclick = () => {
            secaoPizzas.classList.remove('hidden');
            secaoEsfihas.classList.add('hidden');
            secaoBebidas.classList.add('hidden');
            btnPizzas.classList.add('active');
            btnEsfihas.classList.remove('active');
            btnBebidas.classList.remove('active');
            carregarPizzas();
        };
        document.getElementById('btnEsfihas').onclick = () => {
            secaoPizzas.classList.add('hidden');
            secaoEsfihas.classList.remove('hidden');
            secaoBebidas.classList.add('hidden');
            btnPizzas.classList.remove('active');
            btnEsfihas.classList.add('active');
            btnBebidas.classList.remove('active');
            carregarEsfihas();
        };
        document.getElementById('btnBebidas').onclick = () => {
            secaoPizzas.classList.add('hidden');
            secaoEsfihas.classList.add('hidden');
            secaoBebidas.classList.remove('hidden');
            btnPizzas.classList.remove('active');
            btnEsfihas.classList.remove('active');
            btnBebidas.classList.add('active');
            carregarBebidas();
        };

        // Funções para mensagens
        function mostrarAlerta(titulo, mensagem) {
            document.getElementById('alertTitle').textContent = titulo;
            document.getElementById('alertMessage').textContent = mensagem;
            document.getElementById('customAlert').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeCustomAlert() {
            document.getElementById('customAlert').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        // === CRUD PIZZAS ===
        function carregarPizzas() {
            fetch('/api/listar-pizzas/')
                .then(res => res.json())
                .then(pizzas => {
                    const lista = document.getElementById('listaPizzas');
                    lista.innerHTML = '';
                    pizzas.forEach(pizza => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <img src="http://147.79.82.109:8000${pizza.imagem}" alt="${pizza.nome}">
                            <div class="item-info">
                                <div class="item-name">${pizza.nome}</div>
                                <div class="item-price">R$ ${pizza.preco}</div>
                                <div class="item-description">${pizza.ingredientes}</div>
                            </div>
                            <div class="item-actions">
                                <button class="edit-button" onclick="editarPizza(${pizza.id}, '${pizza.nome}', '${pizza.preco}', \`${pizza.ingredientes}\`)">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="delete-button" onclick="excluirPizza(${pizza.id})">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </div>
                        `;
                        lista.appendChild(li);
                    });
                });
        }

        function editarPizza(id, nome, preco, ingredientes) {
            const listItem = document.querySelector(`#listaPizzas li:nth-child(${[...document.querySelectorAll('#listaPizzas li')].findIndex(li => li.textContent.includes(nome)) + 1})`);
            if (!listItem.querySelector('.edit-form')) {
                const editForm = document.createElement('div');
                editForm.classList.add('edit-form');
                editForm.innerHTML = `
                    <div class="form-group">
                        <label>Nome:</label>
                        <input type="text" value="${nome}" placeholder="Nome">
                    </div>
                    <div class="form-group">
                        <label>Preço (R$):</label>
                        <input type="number" step="0.01" value="${preco}" placeholder="Preço">
                    </div>
                    <div class="form-group">
                        <label>Ingredientes:</label>
                        <textarea placeholder="Ingredientes">${ingredientes}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Nova Imagem (opcional):</label>
                        <input type="file" accept="image/*">
                    </div>
                    <div class="form-actions">
                        <button onclick="salvarEdicaoPizza(this.parentNode.parentNode, ${id})">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                        <button onclick="cancelarEdicao(this.parentNode.parentNode)">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                `;
                listItem.appendChild(editForm);
            }
        }

        function salvarEdicaoPizza(formElement, id) {
            const nome = formElement.querySelector('input[type="text"]').value;
            const preco = formElement.querySelector('input[type="number"]').value;
            const ingredientes = formElement.querySelector('textarea').value;
            const imagemInput = formElement.querySelector('input[type="file"]');
            const formData = new FormData();
            formData.append("nome", nome);
            formData.append("preco", preco);
            formData.append("ingredientes", ingredientes);
            if (imagemInput.files.length > 0) {
                formData.append("imagem", imagemInput.files[0]);
            }

            fetch(`/api/pizza/${id}/`, {
                method: 'PUT',
                body: formData
            }).then(res => res.json())
              .then(data => {
                  mostrarAlerta('Sucesso', data.mensagem || 'Pizza atualizada com sucesso');
                  carregarPizzas();
              });
        }

        function cancelarEdicao(formElement) {
            formElement.remove();
        }

        function excluirPizza(id) {
            if (confirm("Tem certeza que deseja excluir esta pizza?")) {
                fetch(`/api/pizza/${id}/`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        mostrarAlerta('Sucesso', data.mensagem || 'Pizza excluída com sucesso');
                        carregarPizzas();
                    });
            }
        }

        // === CRUD ESFIHAS ===
        function carregarEsfihas() {
            fetch('/api/listar-esfihas/')
                .then(res => res.json())
                .then(esfihas => {
                    const lista = document.getElementById('listaEsfihas');
                    lista.innerHTML = '';
                    esfihas.forEach(esfiha => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <img src="http://147.79.82.109:8000${esfiha.imagem}" alt="${esfiha.nome}">
                            <div class="item-info">
                                <div class="item-name">${esfiha.nome}</div>
                                <div class="item-category">${esfiha.tipo}</div>
                                <div class="item-price">R$ ${esfiha.preco}</div>
                                <div class="item-description">${esfiha.ingredientes}</div>
                            </div>
                            <div class="item-actions">
                                <button class="edit-button" onclick="editarEsfiha(${esfiha.id}, '${esfiha.nome}', '${esfiha.tipo}', '${esfiha.preco}', \`${esfiha.ingredientes}\`)">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="delete-button" onclick="excluirEsfiha(${esfiha.id})">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </div>
                        `;
                        lista.appendChild(li);
                    });
                });
        }

        function editarEsfiha(id, nome, tipo, preco, ingredientes) {
            const listItem = document.querySelector(`#listaEsfihas li:nth-child(${[...document.querySelectorAll('#listaEsfihas li')].findIndex(li => li.textContent.includes(nome)) + 1})`);
            if (!listItem.querySelector('.edit-form')) {
                const editForm = document.createElement('div');
                editForm.classList.add('edit-form');
                editForm.innerHTML = `
                    <div class="form-group">
                        <label>Nome:</label>
                        <input type="text" value="${nome}" placeholder="Nome">
                    </div>
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="tipo-select">
                            <option value="simples" ${tipo === 'simples' ? 'selected' : ''}>Simples</option>
                            <option value="tradicional" ${tipo === 'tradicional' ? 'selected' : ''}>Tradicional</option>
                            <option value="especiais" ${tipo === 'especiais' ? 'selected' : ''}>Especiais</option>
                            <option value="premium" ${tipo === 'premium' ? 'selected' : ''}>Premium</option>
                            <option value="doces_gourmet" ${tipo === 'doces_gourmet' ? 'selected' : ''}>Doces Gourmet</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Preço (R$):</label>
                        <input type="number" step="0.01" value="${preco}" placeholder="Preço">
                    </div>
                    <div class="form-group">
                        <label>Ingredientes:</label>
                        <textarea placeholder="Ingredientes">${ingredientes}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Nova Imagem (opcional):</label>
                        <input type="file" accept="image/*">
                    </div>
                    <div class="form-actions">
                        <button onclick="salvarEdicaoEsfiha(this.parentNode.parentNode, ${id})">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                        <button onclick="cancelarEdicao(this.parentNode.parentNode)">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                `;
                listItem.appendChild(editForm);
            }
        }

        function salvarEdicaoEsfiha(formElement, id) {
            const nome = formElement.querySelector('input[type="text"]').value;
            const tipo = formElement.querySelector('#tipo-select').value;
            const preco = formElement.querySelector('input[type="number"]').value;
            const ingredientes = formElement.querySelector('textarea').value;
            const imagemInput = formElement.querySelector('input[type="file"]');
            const formData = new FormData();
            formData.append("nome", nome);
            formData.append("tipo", tipo);
            formData.append("preco", preco);
            formData.append("ingredientes", ingredientes);
            if (imagemInput.files.length > 0) {
                formData.append("imagem", imagemInput.files[0]);
            }

            fetch(`/api/esfiha/${id}/`, {
                method: 'PUT',
                body: formData
            }).then(res => res.json())
              .then(data => {
                  mostrarAlerta('Sucesso', data.mensagem || 'Esfiha atualizada com sucesso');
                  carregarEsfihas();
              });
        }

        function excluirEsfiha(id) {
            if (confirm("Tem certeza que deseja excluir esta esfiha?")) {
                fetch(`/api/esfiha/${id}/`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        mostrarAlerta('Sucesso', data.mensagem || 'Esfiha excluída com sucesso');
                        carregarEsfihas();
                    });
            }
        }

        // === CRUD BEBIDAS ===
        function carregarBebidas() {
            fetch('/api/listar-bebidas/')
                .then(res => res.json())
                .then(bebidas => {
                    const lista = document.getElementById('listaBebidas');
                    lista.innerHTML = '';
                    bebidas.forEach(bebida => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <img src="http://147.79.82.109:8000${bebida.imagem}" alt="${bebida.nome}">
                            <div class="item-info">
                                <div class="item-name">${bebida.nome}</div>
                                <div class="item-price">R$ ${bebida.preco}</div>
                                <div class="item-description">${bebida.descricao}</div>
                            </div>
                            <div class="item-actions">
                                <button class="edit-button" onclick="editarBebida(${bebida.id}, '${bebida.nome}', '${bebida.preco}', \`${bebida.descricao}\`)">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="delete-button" onclick="excluirBebida(${bebida.id})">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </div>
                        `;
                        lista.appendChild(li);
                    });
                });
        }

        function editarBebida(id, nome, preco, descricao) {
            const listItem = document.querySelector(`#listaBebidas li:nth-child(${[...document.querySelectorAll('#listaBebidas li')].findIndex(li => li.textContent.includes(nome)) + 1})`);
            if (!listItem.querySelector('.edit-form')) {
                const editForm = document.createElement('div');
                editForm.classList.add('edit-form');
                editForm.innerHTML = `
                    <div class="form-group">
                        <label>Nome:</label>
                        <input type="text" value="${nome}" placeholder="Nome">
                    </div>
                    <div class="form-group">
                        <label>Preço (R$):</label>
                        <input type="number" step="0.01" value="${preco}" placeholder="Preço">
                    </div>
                    <div class="form-group">
                        <label>Descrição:</label>
                        <textarea placeholder="Descrição">${descricao}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Nova Imagem (opcional):</label>
                        <input type="file" accept="image/*">
                    </div>
                    <div class="form-actions">
                        <button onclick="salvarEdicaoBebida(this.parentNode.parentNode, ${id})">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                        <button onclick="cancelarEdicao(this.parentNode.parentNode)">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                `;
                listItem.appendChild(editForm);
            }
        }

        function salvarEdicaoBebida(formElement, id) {
            const nome = formElement.querySelector('input[type="text"]').value;
            const preco = formElement.querySelector('input[type="number"]').value;
            const descricao = formElement.querySelector('textarea').value;
            const imagemInput = formElement.querySelector('input[type="file"]');
            const formData = new FormData();
            formData.append("nome", nome);
            formData.append("preco", preco);
            formData.append("descricao", descricao);
            if (imagemInput.files.length > 0) {
                formData.append("imagem", imagemInput.files[0]);
            }

            fetch(`/api/bebida/${id}/`, {
                method: 'PUT',
                body: formData
            }).then(res => res.json())
              .then(data => {
                  mostrarAlerta('Sucesso', data.mensagem || 'Bebida atualizada com sucesso');
                  carregarBebidas();
              });
        }

        function excluirBebida(id) {
            if (confirm("Tem certeza que deseja excluir esta bebida?")) {
                fetch(`/api/bebida/${id}/`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        mostrarAlerta('Sucesso', data.mensagem || 'Bebida excluída com sucesso');
                        carregarBebidas();
                    });
            }
        }

        // Carregar pizzas inicialmente
        window.onload = () => {
            carregarPizzas();
        };
    </script>
</body>
</html>
